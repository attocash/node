on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3

      - name: tags
        run: git fetch --tags

      - name: release
        run: |
          echo $TOKEN | docker login ghcr.io -u rotilho --password-stdin
          
          RELEASE_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/release\///')
          LATEST_TAG=$(git tag --list "$RELEASE_BRANCH.*" --sort=-v:refname | head -n1)
          MINOR=${LATEST_TAG##*.}
          
          if [ -n "$MINOR" ]; then
            NEXT_MINOR=$((MINOR + 1))
          else
            NEXT_MINOR=0
          fi
          
          if [ "${{ inputs.environment }}" == "dev" ]; then
            NEXT_TAG="$RELEASE_BRANCH.$NEXT_MINOR"
          else
            NEXT_TAG=$LATEST_TAG
          fi
          
          docker pull ghcr.io/attocash/node:${{ github.sha }}
          docker tag ghcr.io/attocash/node:${{ github.sha }} ghcr.io/attocash/node:${NEXT_TAG}-${{ inputs.environment }}
          docker push ghcr.io/attocash/node:${NEXT_TAG}-${{ inputs.environment }}
          
          if [ "${{ inputs.environment }}" != "dev" ]; then
            git tag v$GIT_NEXT_TAG
            git push origin v$GIT_NEXT_TAG
          fi
        env:
          TOKEN: ${{ secrets.token }}