name: Cleanup Old Docker Images

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Clean up
        run: |
          # Fetch all package versions from the GitHub Package Registry for AttoCash/node
          PACKAGE_VERSIONS=$(curl --request GET \
            --url "https://api.github.com/orgs/AttoCash/packages/container/node/versions" \
            --header "Authorization: Bearer $TOKEN" \
            --header "Accept: application/vnd.github.v3+json")
          
          echo "PACKAGE_VERSIONS: $PACKAGE_VERSIONS"
          
          # Extract all versions and creation dates 
          VERSIONS_TO_CHECK=$(echo $PACKAGE_VERSIONS | jq -r '.[] | select(.name != "main" and (.name | test("^[0-9]+\\.[0-9]+\\.[0-9]+$") | not)) | .name + " " + .created_at')
          
          echo "VERSIONS_TO_CHECK: $VERSIONS_TO_CHECK"
          
          TWO_WEEKS_AGO=$(date -d "2 weeks ago" +%Y-%m-%dT%H:%M:%S)
          
          # Iterate over versions and delete those older than 2 weeks and don't match the criteria
          while IFS= read -r line; do
              VERSION=$(echo $line | cut -d ' ' -f1)
              CREATION_DATE=$(echo $line | cut -d ' ' -f2)
          
              if [[ "$CREATION_DATE" < "$TWO_WEEKS_AGO" ]]; then
                  echo "Deleting version: $VERSION"
                  # Delete the old version (NOTE: You might want to comment out the deletion for debugging)
                  # curl --request DELETE \
                  #   --url "https://api.github.com/orgs/AttoCash/packages/container/node/versions/$VERSION" \
                  #   --header "Authorization: Bearer $TOKEN" \
                  #   --header "Accept: application/vnd.github.v3+json"
              fi
          done <<< "$VERSIONS_TO_CHECK"
        env:
          TOKEN: ${{ secrets.TOKEN }}